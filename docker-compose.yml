services:
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        PHP_VERSION: "8.4"
        NODE_VERSION: "20"
    container_name: product_app
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: http://localhost
      LOG_CHANNEL: stderr
      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:-product}
      DB_USERNAME: ${DB_USERNAME:-product}
      DB_PASSWORD: ${DB_PASSWORD:-product}
      QUEUE_CONNECTION: database
      SESSION_DRIVER: file
      CACHE_DRIVER: file
      FILESYSTEM_DISK: local
    volumes:
      # Mount storage for persistent data
      - storage:/var/www/html/storage
      # Mount .env for configuration
      - ./.env:/var/www/html/.env:ro
      # Mount code directories (allows code changes without rebuild)
      - ./app:/var/www/html/app:ro
      - ./config:/var/www/html/config:ro
      - ./routes:/var/www/html/routes:ro
      - ./resources:/var/www/html/resources:ro
      - ./database:/var/www/html/database:ro
      # Don't mount bootstrap - let it use the one from image with proper permissions
      # bootstrap/cache needs to be writable for Laravel package manifest
      # - ./bootstrap:/var/www/html/bootstrap:ro
      # Mount public to host so nginx can serve it
      # public/build will be copied from image backup to host in entrypoint
      - ./public:/var/www/html/public
    depends_on:
      db:
        condition: service_healthy
    networks:
      - appnet

  web:
    image: nginx:stable-alpine
    container_name: product_web
    ports:
      - "8080:80"
    volumes:
      # Mount public directory from host (includes built assets copied from app container)
      - ./public:/var/www/html/public:ro
      # Mount storage for uploaded files
      - storage:/var/www/html/storage:ro
      # Nginx config
      - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - app
    networks:
      - appnet

  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: worker
      args:
        PHP_VERSION: "8.4"
        NODE_VERSION: "20"
    container_name: product_worker
    environment:
      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:-product}
      DB_USERNAME: ${DB_USERNAME:-product}
      DB_PASSWORD: ${DB_PASSWORD:-product}
      QUEUE_CONNECTION: database
    volumes:
      # Mount storage for persistent data
      - storage:/var/www/html/storage
      # Mount .env for configuration
      - ./.env:/var/www/html/.env:ro
      # Mount code directories (same as app)
      - ./app:/var/www/html/app:ro
      - ./config:/var/www/html/config:ro
      - ./routes:/var/www/html/routes:ro
      - ./resources:/var/www/html/resources:ro
      - ./database:/var/www/html/database:ro
      # Don't mount bootstrap - let it use the one from image with proper permissions
      # bootstrap/cache needs to be writable for Laravel package manifest
      # - ./bootstrap:/var/www/html/bootstrap:ro
      - ./public:/var/www/html/public:ro
    depends_on:
      - app
    networks:
      - appnet

  db:
    image: mysql:8.0
    container_name: product_db
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-product}
      MYSQL_USER: ${DB_USERNAME:-product}
      MYSQL_PASSWORD: ${DB_PASSWORD:-product}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
    ports:
      - "33060:3306"
    volumes:
      - dbdata:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${MYSQL_ROOT_PASSWORD}",
        ]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - appnet
    # Only start db service if using MySQL (remove profile to always start)
    # profiles:
    #   - mysql

volumes:
  dbdata:
  storage:

networks:
  appnet:
    driver: bridge
